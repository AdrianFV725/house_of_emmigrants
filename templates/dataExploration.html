<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Exploration Dashboard</title>

    <!--GENERAL STYLE-->
    <link rel="stylesheet" href="../static/css/general.css" />
    <!--SPECIFIC STYLE-->
    <link rel="stylesheet" href="../static/css/dataExploration.css" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
      crossorigin="anonymous"
    />

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
      crossorigin="anonymous"
    ></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <!--Montserrat-->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <!-- Hamburger Button -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
        
                <!-- Navigation Items -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="nav-list navbar-nav me-auto">
                        <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                        {% if session.get('admin_id') %}
                            <li class="nav-item"><a href="/uploadTool" class="nav-link">Upload Files</a></li>
                        {% endif %}
                        <li class="nav-item"><a href="/dataExploration" class="nav-link active">Data Exploration Dashboard</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link">About & Contact</a></li>
                    </ul>
                    <ul class="nav-list navbar-nav login">
                        {% if session.get('admin_id') %}
                          <li class="nav-item dropdown">
                              <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                  ðŸ‘¤ {{ session.get('admin_email') }}
                              </a>
                              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                                  <li><a class="dropdown-item" href="/logout">Log out</a></li>
                              </ul>
                          </li>
                      {% else %}
                          <li class="nav-item"><a href="/login" class="nav-link">Login</a></li>
                      {% endif %}
                    </ul>                    
                </div>
            </div>
        </nav>     
    </header>

    <div class="container-fluid p-0">
      <section class="hero text-center py-4">
        <h1>Data Exploration Dashboard</h1>
        <p class="mt-2">Insights from emigration journeys</p>
      </section>
    </div>

    <div class="container">
      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-outline-primary">Region</button>
        <button class="btn btn-outline-primary">Time Period</button>
        <button class="btn btn-outline-secondary">Reset</button>
      </div>

      <!-- Timeline -->
      <section class="mb-5">
        <h2>Travels per Year</h2>
        <div id="timeline-chart" style="height:400px;"></div>
        <button class="btn btn-sm btn-link mt-2">â¬‡ Download</button>
      </section>

      <!-- Top Keywords -->
      <section class="mb-5">
        <h2>Top Keywords</h2>
        <div id="wordfreq-chart" style="height:400px;"></div>
        <button class="btn btn-sm btn-link mt-2">â¬‡ Download</button>
      </section>

      <!-- Geographic Distribution -->
      <section class="mb-5">
        <h2>Destination Cities</h2>
        <div id="geo-chart" style="height:400px;"></div>
        <button class="btn btn-sm btn-link mt-2">â¬‡ Download</button>
      </section>

      <!-- Recent Journeys -->
      <section class="stories mb-5">
        <h2><i class="fas fa-route me-2"></i> Recent Journeys</h2>

        <div class="input-group mb-3">
          <input id="searchInput" type="text" class="form-control" placeholder="Search journey by title..." onkeyup="filterJourneys()" />
          <button class="btn btn-outline-secondary" onclick="filterJourneys()"><i class="fas fa-search"></i></button>
        </div>

        <div class="list-group">
          {% for journey in stories %}
            <div class="list-group-item mb-4">
              <!-- Main Info -->
              <h5 class="mb-1">{{ journey.title }}</h5>

              <!-- Story Summary -->
              <div class="mt-2">
                <p>{{ journey.summary }}</p>
              </div>

              <!-- Demographics -->
              <div class="mt-3 p-3 bg-light rounded">
                <h6>Demographic Information</h6>
                <ul class="mb-0">
                  {% if journey.sex %}<li><strong>Sex:</strong> {{ journey.sex }}</li>{% endif %}
                  {% if journey.marital_status %}<li><strong>Marital Status:</strong> {{ journey.marital_status }}</li>{% endif %}
                  {% if journey.education_level %}<li><strong>Education Level:</strong> {{ journey.education_level }}</li>{% endif %}
                  {% if journey.legal_status %}<li><strong>Legal Status:</strong> {{ journey.legal_status }}</li>{% endif %}
                  {% if journey.mentions %}
                    <li><strong>Mentions:</strong>
                      {% set printed = false %}
                      {% for m in journey.mentions %}
                        {% if m %}
                          {% if printed %}, {% endif %}{{ m }}
                          {% set printed = true %}
                        {% endif %}
                      {% endfor %}
                    </li>
                  {% endif %}
                </ul>
              </div>

              <!-- Travel Info -->
              <div class="mt-3 p-3 bg-white border rounded">
                <h6>Travel Information</h6>
                <ul class="mb-0">
                  {% if journey.departure_date %}
                    <li><strong>Departure Date:</strong> {{ journey.departure_date.strftime('%Y-%m-%d') }}</li>
                  {% endif %}
                  {% if journey.destination_city and journey.destination_country %}
                    <li><strong>Destination:</strong> {{ journey.destination_city }}, {{ journey.destination_country }}</li>
                  {% endif %}
                  {% if journey.motive %}
                    <li><strong>Motive:</strong> {{ journey.motive }}</li>
                  {% endif %}
                  {% if journey.travel_duration %}
                    <li><strong>Duration:</strong> {{ journey.travel_duration }}</li>
                  {% endif %}
                  {% if journey.return_plans %}
                    <li><strong>Return Plans:</strong> {{ journey.return_plans }}</li>
                  {% endif %}
                  {% if journey.methods %}
                    <li><strong>Travel Methods:</strong>
                      {% set ns = namespace(seen=[]) %}
                      {% set first = true %}
                      {% for m in journey.methods %}
                        {% if m and m not in ns.seen %}
                          {% if not first %}, {% endif %}{{ m }}
                          {% set first = false %}
                          {% set ns.seen = ns.seen + [m] %}
                        {% endif %}
                      {% endfor %}
                    </li>
                  {% endif %}
                </ul>
              </div>
            </div>
          {% else %}
            <p>No recent journeys available.</p>
          {% endfor %}
        </div>
      </section>
    </div>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
      function filterJourneys() {
          const query = document.getElementById('searchInput').value.toLowerCase();
          document.querySelectorAll('.list-group-item').forEach(item => {
          const title = item.querySelector('h5').textContent.toLowerCase();
          item.style.display = title.includes(query) ? '' : 'none';
          });
      }

      const years   = {{ timeline_years|safe }};
      const counts  = {{ timeline_counts|safe }};
      const wfWords = {{ wf_words|safe }};
      const wfCnts  = {{ wf_counts|safe }};
      const geoC    = {{ geo_countries|safe }};
      const geoCnt  = {{ geo_counts|safe }};

      Highcharts.chart('timeline-chart', {
        chart: { type: 'line' },
        title: { text: null },
        xAxis: { categories: years },
        yAxis: { title: { text: 'Count' } },
        series: [{ name: 'Travels', data: counts }]
      });

      Highcharts.chart('wordfreq-chart', {
        chart: { type: 'column' },
        title: { text: null },
        xAxis: { categories: wfWords, crosshair: true },
        yAxis: { title: { text: 'Frequency' } },
        series: [{ name: 'Keywords', data: wfCnts }]
      });

      Highcharts.chart('geo-chart', {
        chart: { type: 'pie' },
        title: { text: null },
        series: [{
          name: 'Count',
          colorByPoint: true,
          data: geoC.map((c,i) => ({ name: c, y: geoCnt[i] }))
        }]
      });
    </script>

    <footer>
        <div class="footer-content">
            <div class="logo"><img src="../static/images/Kulturparken.png"></div>
            <div>
                <p>House of Emigrants visiting address:</p>
                <p>Vilhelm Mobergs gata 4, 352 29 VÃ¤xjÃ¶.</p>
            </div>
            <div>
                <p>About the House of Emigrants</p>
                <p><a href="https://www.kulturparkensmaland.se/en/the-house-of-emigrants/">https://www.kulturparkensmaland.se/en/the-house-of-emigrants/</a></p>
                <p>Contact information:</p>
                <p>+46 470-70 42 00</p>
                <p><a href="mailto:information@kulturparkensmaland.se">information@kulturparkensmaland.se</a></p>
            </div>
        </div>
    </footer>
  </body>
</html>
